name: Deploy Backend

on:
     push:
          branches: [main]

jobs:
     deploy:
          runs-on: ubuntu-latest
          steps:
               - uses: actions/checkout@v4

               - name: Setup Node
                 uses: actions/setup-node@v4
                 with:
                      node-version: 20

               - name: Install dependencies
                 run: npm ci

               - name: Create .env
                 run: echo "${{ secrets.ENV_PRODUCTION }}" > .env

               - name: Deploy to EC2
                 uses: appleboy/ssh-action@v0.1.10
                 with:
                      host: ${{ secrets.DEPLOY_HOST }}
                      username: ${{ secrets.DEPLOY_USER }}
                      key: ${{ secrets.DEPLOY_KEY }}
                      script: |
                           cd ${{ secrets.DEPLOY_PATH }}
                           git pull origin main
                           cp .env .env.production  # যদি আপনি .env.production লোড করেন
                           npm ci --omit=dev
                           npm run build --if-present
                           pm2 restart senaeya_backend || pm2 start "npm run start:concurrently" --name senaeya_backend
